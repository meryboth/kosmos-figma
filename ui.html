<!DOCTYPE html>
<html>
<head>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 13px;
    color: #333;
    padding: 16px;
    background: #fafafa;
  }
  h1 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
  .subtitle { font-size: 11px; color: #888; margin-bottom: 16px; }
  label { display: block; font-size: 11px; font-weight: 600; color: #666; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  select, textarea {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    background: #fff;
    outline: none;
    transition: border-color 0.2s;
  }
  select:focus, textarea:focus { border-color: #424242; }
  textarea { min-height: 120px; resize: vertical; font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 11px; }
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
  }
  .btn-primary { background: #424242; color: #fff; }
  .btn-primary:hover { background: #333; }
  .btn-primary:disabled { background: #bbb; cursor: not-allowed; }
  .btn-secondary { background: #fff; color: #666; border: 1px solid #ddd; margin-top: 8px; }
  .btn-secondary:hover { background: #f5f5f5; }
  .section { margin-bottom: 16px; }
  .preview-box {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 6px;
    padding: 12px;
    margin-top: 8px;
  }
  .screen-list { list-style: none; }
  .screen-list li {
    padding: 6px 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
  }
  .screen-list li:last-child { border-bottom: none; }
  .screen-name { font-weight: 600; color: #424242; }
  .screen-count { color: #999; font-size: 11px; }
  .status {
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 12px;
    margin-top: 12px;
    display: none;
  }
  .status.visible { display: block; }
  .status.info { background: #f0f4ff; color: #3b5998; border: 1px solid #d0dbf0; }
  .status.success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
  .status.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
  .tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid #eee; }
  .tab {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    color: #999;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    background: none;
    border-top: none; border-left: none; border-right: none;
  }
  .tab.active { color: #424242; border-bottom-color: #424242; }
  .tab:hover { color: #666; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .info-text { font-size: 11px; color: #999; margin-top: 4px; }
  .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .btn-refresh {
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 11px;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-refresh:hover { background: #f5f5f5; border-color: #bbb; }
  .platform-badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 3px;
    background: #e8e8e8;
    color: #555;
    margin-left: 8px;
  }
</style>
</head>
<body>

<div class="header-row">
  <div>
    <h1>Kosmos</h1>
    <p class="subtitle">Wireframe Renderer</p>
  </div>
  <button class="btn-refresh" id="btn-refresh" title="Reload projects and wireframes">Refresh</button>
</div>

<div class="tabs">
  <button class="tab active" data-tab="supabase">From Project</button>
  <button class="tab" data-tab="manual">Paste JSON</button>
</div>

<!-- Tab: From Supabase -->
<div id="tab-supabase" class="tab-content active">
  <div class="section">
    <label>Project</label>
    <select id="project-select">
      <option value="">Loading projects...</option>
    </select>
  </div>

  <div id="preview-section" class="section" style="display:none;">
    <label>Wireframe Preview</label>
    <div class="preview-box">
      <p id="project-name" style="font-weight:600; margin-bottom:8px;"></p>
      <ul class="screen-list" id="screen-list"></ul>
    </div>
  </div>

  <button id="btn-render" class="btn btn-primary" disabled>Render in Figma</button>
</div>

<!-- Tab: Paste JSON -->
<div id="tab-manual" class="tab-content">
  <div class="section">
    <label>WireframeSpec JSON</label>
    <textarea id="json-input" placeholder='Paste your wireframeSpec JSON here...'></textarea>
    <p class="info-text">Paste the wireframeSpec object (not the full output with figmaPrompt).</p>
  </div>
  <button id="btn-render-manual" class="btn btn-primary">Render from JSON</button>
</div>

<button id="btn-cancel" class="btn btn-secondary">Cancel</button>

<div id="status" class="status"></div>

<script>
  // ─── Config ──────────────────────────────────────────────
  const SUPABASE_URL = 'https://qxlnlmqbxirmthktwfex.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4bG5sbXFieGlybXRoa3R3ZmV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5OTc2NDksImV4cCI6MjA4NDU3MzY0OX0.W9pWywwOhjvvCQwFsLrZJrZV0MbM3355km6JKCtAOsU';

  const headers = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json'
  };

  // ─── State ───────────────────────────────────────────────
  let projects = [];
  let wireframes = {};
  let selectedSpec = null;

  // ─── DOM ─────────────────────────────────────────────────
  const projectSelect = document.getElementById('project-select');
  const previewSection = document.getElementById('preview-section');
  const projectNameEl = document.getElementById('project-name');
  const screenListEl = document.getElementById('screen-list');
  const btnRender = document.getElementById('btn-render');
  const btnRenderManual = document.getElementById('btn-render-manual');
  const btnCancel = document.getElementById('btn-cancel');
  const btnRefresh = document.getElementById('btn-refresh');
  const statusEl = document.getElementById('status');
  const jsonInput = document.getElementById('json-input');

  // ─── Tabs ────────────────────────────────────────────────
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
  });

  // ─── Status Helpers ──────────────────────────────────────
  function showStatus(msg, type) {
    statusEl.textContent = msg;
    statusEl.className = 'status visible ' + type;
  }
  function hideStatus() { statusEl.className = 'status'; }

  // ─── Extract wireframeSpec from DB content ────────────────
  // Handles both wrapped { figmaPrompt, wireframeSpec } and unwrapped { screens, style } formats
  function extractSpec(content) {
    if (!content) return null;
    // Wrapped format: { figmaPrompt: "...", wireframeSpec: { screens: [...] } }
    if (content.wireframeSpec && content.wireframeSpec.screens) {
      return content.wireframeSpec;
    }
    // Unwrapped format: { screens: [...], style: {...}, ... }
    if (content.screens && Array.isArray(content.screens)) {
      return content;
    }
    return null;
  }

  // ─── Load Projects & Wireframes ──────────────────────────
  async function loadData() {
    try {
      hideStatus();
      projectSelect.innerHTML = '<option value="">Loading...</option>';

      // Fetch projects
      const projRes = await fetch(`${SUPABASE_URL}/rest/v1/projects?select=id,title&order=created_at.desc`, { headers });
      if (!projRes.ok) throw new Error(`Projects fetch failed: ${projRes.status} ${projRes.statusText}`);
      projects = await projRes.json();

      // Fetch wireframes
      const wfRes = await fetch(`${SUPABASE_URL}/rest/v1/wireframes?select=project_id,content`, { headers });
      if (!wfRes.ok) throw new Error(`Wireframes fetch failed: ${wfRes.status} ${wfRes.statusText}`);
      const wfData = await wfRes.json();

      // Index wireframes by project_id
      wireframes = {};
      wfData.forEach(wf => { wireframes[wf.project_id] = wf.content; });

      // Debug: show what we got
      const debugInfo = `${projects.length} projects, ${wfData.length} wireframes`;

      // Filter projects that have valid wireframes
      const projectsWithWireframes = projects.filter(p => {
        const spec = extractSpec(wireframes[p.id]);
        return spec !== null;
      });

      projectSelect.innerHTML = '';
      if (projectsWithWireframes.length === 0) {
        projectSelect.innerHTML = '<option value="">No projects with wireframes found</option>';
        // Show debug info to help diagnose
        const keys = wfData.length > 0 ? Object.keys(wfData[0].content || {}).join(', ') : 'N/A';
        showStatus(`Debug: ${debugInfo}. First wireframe keys: [${keys}]`, 'info');
        return;
      }

      projectSelect.innerHTML = '<option value="">Select a project...</option>';
      projectsWithWireframes.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.title;
        projectSelect.appendChild(opt);
      });
    } catch (err) {
      projectSelect.innerHTML = '<option value="">Error loading</option>';
      showStatus('Error: ' + err.message, 'error');
    }
  }

  // ─── Refresh ──────────────────────────────────────────────
  btnRefresh.addEventListener('click', () => {
    previewSection.style.display = 'none';
    btnRender.disabled = true;
    selectedSpec = null;
    loadData();
    showStatus('Refreshed!', 'success');
    setTimeout(hideStatus, 1500);
  });

  // ─── Project Selection ───────────────────────────────────
  projectSelect.addEventListener('change', () => {
    const id = projectSelect.value;
    if (!id || !wireframes[id]) {
      previewSection.style.display = 'none';
      btnRender.disabled = true;
      selectedSpec = null;
      return;
    }

    const content = wireframes[id];
    const spec = extractSpec(content);

    if (!spec) {
      showStatus('This project has no valid wireframeSpec. Try refreshing.', 'error');
      previewSection.style.display = 'none';
      btnRender.disabled = true;
      return;
    }

    selectedSpec = spec;
    const platformLabel = spec.platform || 'mobile';
    projectNameEl.innerHTML = (spec.projectName || 'Wireframes') + `<span class="platform-badge">${platformLabel}</span>`;
    screenListEl.innerHTML = '';

    spec.screens.forEach(s => {
      const compCount = (s.layout && s.layout.components) ? s.layout.components.length : 0;
      const li = document.createElement('li');
      li.innerHTML = `<span class="screen-name">${s.name}</span><span class="screen-count">${compCount} components</span>`;
      screenListEl.appendChild(li);
    });

    previewSection.style.display = 'block';
    btnRender.disabled = false;
    hideStatus();
  });

  // ─── Render from Supabase ────────────────────────────────
  btnRender.addEventListener('click', () => {
    if (!selectedSpec) return;
    btnRender.disabled = true;
    showStatus('Sending to Figma...', 'info');
    parent.postMessage({ pluginMessage: { type: 'render-wireframes', spec: selectedSpec } }, '*');
  });

  // ─── Render from Manual JSON ─────────────────────────────
  btnRenderManual.addEventListener('click', () => {
    try {
      const raw = jsonInput.value.trim();
      if (!raw) { showStatus('Please paste a WireframeSpec JSON.', 'error'); return; }
      const parsed = JSON.parse(raw);
      // Accept both wrapped and unwrapped formats
      const spec = extractSpec(parsed) || parsed;
      if (!spec.screens || !Array.isArray(spec.screens)) {
        showStatus('Invalid spec: missing "screens" array.', 'error');
        return;
      }
      btnRenderManual.disabled = true;
      showStatus('Sending to Figma...', 'info');
      parent.postMessage({ pluginMessage: { type: 'render-wireframes', spec } }, '*');
    } catch (err) {
      showStatus('Invalid JSON: ' + err.message, 'error');
    }
  });

  // ─── Cancel ──────────────────────────────────────────────
  btnCancel.addEventListener('click', () => {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
  });

  // ─── Messages from Plugin Code ───────────────────────────
  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;
    if (!msg) return;

    if (msg.type === 'progress') {
      showStatus(msg.message, 'info');
    } else if (msg.type === 'done') {
      showStatus(msg.message, 'success');
      btnRender.disabled = false;
      btnRenderManual.disabled = false;
    }
  };

  // ─── Init ────────────────────────────────────────────────
  loadData();
</script>
</body>
</html>
